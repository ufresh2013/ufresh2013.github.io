
<!DOCTYPE html>
<html lang="">


  <head><meta name="generator" content="Hexo 3.9.0">
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
    <meta name="theme-color" content="#202020">
    <meta http-equiv="x-ua-compatible" content="ie=edge">

    
        <meta name="keywords" content="">
        

          
              <meta name="description" content="Canvas实现白板功能">
              

                <link rel="icon" type="image/x-icon" href="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAACAAAAAgCAMAAAEzo7pQAAACzVBMVEXHx8fLy8vMzMzNzc3Ozs7Pz8/Q0NDR0dHS0tLT09PU1NTV1dXW1tbX19fY2NjZ2dna2trb29vc3Nzd3d3e3t7f39/g4ODh4eHi4uLj4+Pk5OTl5eXm5ubn5+fo6Ojp6enq6urr6+vs7Ozt7e3y8vL09PT19fX29vb39/f4+Pj6+vr9/f3+/v7////Ozs7Pz8/Q0NDS0tLU1NTW1tbX19fY2NjZ2dna2trb29vc3Nzd3d3e3t7S0tLV1dXZ2dna2trc3NzY2Njc3Nzj4+PV1dXT09PX19fZ2dnc3NzU1NTU1NTY2Nji4uLS0tLS0tLW1tbU1NTf39/Hx8fT09PJycnIyMjDw8PGxsbHx8fBwcHFxcXf39/JycnS0tK8vLy3t7fBwcG4uLi8vLzCwsKwsLCioqKhoaGdnZ2ZmZmbm5uXl5ehoaGZmZmPj4+ampqJiYmVlZWGhoaDg4OSkpKFhYWAgICQkJB2dnZ9fX16enp4eHh0dHRvb29ycnJ1dXVra2tubm5tbW1eXl5paWllZWVkZGR4eHhYWFhcXFxaWlpbW1tOTk5NTU1MTExOTk5QUFBISEhgYGBEREQ3NzdBQUFISEhCQkJBQUE0NDQ6Ojo2NjY2NjYxMTEzMzMnJycwMDApKSkrKysZGRkpKSkTExMVFRUfHx8gICAiIiItLS0cHBwdHR0lJSUZGRkiIiIdHR0XFxcjIyMREREiIiIAAAABAQEDAwMEBAQGBgYHBwcICAgJCQkKCgoLCwsMDAwNDQ0ODg4PDw8QEBARERESEhITExMUFBQVFRUWFhYXFxcYGBgZGRkaGhobGxscHBwdHR0eHh4fHx8gICAhISEiIiIjIyMkJCQmJiYnJycoKCgrKyssLCwwMDAxMTE3NzdDQ0NLS0tPT09WVlZZWVlkZGRoaGhra2tsbGxzc3N2dnZ9fX2BgYGNjY2Pj4+dnZ1edkJeAAAAtHRSTlMAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAQEBAQEBAQEBAQEBAQECAgICAgMDAwQFBggICQoKDA4QEBMUFhYYGRocHB8hIiMkKSw1ODg9RkpOUFNVV1lmaGtsbnFydHd5eYWHiImMj4+Sk5OVlpuipKaqq622v8DBwsPHyMzOz9HS1NXb3uDm5ujq7Ozw8fLy8vLy8vP09vf6+/z8/v5Qqz//AAADDklEQVQYGW3BS2icVRgG4Pf9zvnnkpnMJZPr5GpMa6NISJTEpolaSRG7KBVBcCMIRRAEleJWXbtyobgTFVwILtyIWbltSw2VSK01KcQ0pdGZZEybmT//zH/OZyKNi+jzQCZNYJP3Pn6c6StKOQPCSHbcIv3LUs6WelzBfOt2rzKL/rhkandoZt/vBvQZsQvdIDjPi68SgNaNYCo+vl1uN5nEJ8uprq7fxUnyvbMfibPRKz0YwuRlSZzfzHbVzlhrBmV3t+hPyLChApXALAoJ9GaYAlQGclaoyt9AkyBN6bNTi5ubOv36zqqzFpDXOkpfAdDbv6JprPZ8OQ3bklYrkR+9XJdW67mc2g0LKQlGTxpr5ppK1weYOlC/5M3why8YPMBq9Kd5d8LjkJamyxSAE7reOCY3wz4STAEoxKMGVPhbgLWAuZD5tKzWVTQCxHsfdJx+tnpntfHB552gVdDF7RfeWNqbGPkh9LAB0POoK2CeqK+F6qUeZt8eAUBATpUFkkqdf9K7HZGGIjtIFY8M0Te+Uyvn0fF8KhBXeCrA+vVcWtaA7rSz2ugAUikE20VlGBmZya4pACVIvT3UtPm5SRyKw7as7ToteECl8+48vxsA8a/1r8WQOERNe7bhgEJwgiIQelVAVqE2wD624QAlPde9qJ0BSECJ1gofvgECzOAfiY43H/FXv/kDYwCo98Ynoi8asQJWsE8FaHLM9mxUvw87G0/nX4oGVlZ+3HIe1uOALw53pqNyWcKXEZlCIrC3lpe3lULTJiLHtx+authdBKA2k8m3BwIn/n5tz6kajWMXz7wz1Z+ga1kcYjL21xuIYQJCumYeKwN/9ecsQxP7nIQWyGXSa3ugCWh6zy30WoBIaTWJrbFMEjsBlFqvNCIbQ3brYdMQiVYFaaBvo5LPtSkZ1u43JG2DlhGxhgBB7HNBGQ6EBIVs0HB2Nti7lmw6JY6IuLx07BptdvnsW4UicYQi+mnL3Jjd44sLI0OKo5SgbsqlKz+bc0+Uif8gVCVbnTwZ28FqDf9HSc+bUf1vzMAvsrtVWjkAAAAASUVORK5CYII=">
                <title>
                  Canvas实现白板功能 [ 日常笔记 ]
                </title>
                
                  <!-- stylesheets list from config.yml -->
                  
                    <link rel="stylesheet" href="//cdn.bootcss.com/pure/1.0.0/pure-min.css">
                    
                    <link rel="stylesheet" href="/css/microb.css">
                    
                      
  </head>

<body>
  <div class="container" id="content-outer">
    <div class="inner" id="content-inner">
        <div class="tab">
            <a href="/"><img src="/left.png" /></a>
            <span><a href="/">日常笔记</a></span>
            <!-- <span><a class="tab-search" href="/search/">搜索</a></span> -->
            
              <span><a class="tab-title" id="#Basic" href="/#Basic">Basic</a></span>
            
              <span><a class="tab-title" id="#Browser" href="/#Browser">Browser</a></span>
            
              <span><a class="tab-title" id="#Bug" href="/#Bug">Bug</a></span>
            
              <span><a class="tab-title" id="#CSS" href="/#CSS">CSS</a></span>
            
              <span><a class="tab-title" id="#Debug" href="/#Debug">Debug</a></span>
            
              <span><a class="tab-title" id="#HTML" href="/#HTML">HTML</a></span>
            
              <span><a class="tab-title" id="#HTTP" href="/#HTTP">HTTP</a></span>
            
              <span><a class="tab-title" id="#JS" href="/#JS">JS</a></span>
            
              <span><a class="tab-title" id="#LeetCode" href="/#LeetCode">LeetCode</a></span>
            
              <span><a class="tab-title" id="#NodeJS" href="/#NodeJS">NodeJS</a></span>
            
              <span><a class="tab-title" id="#React" href="/#React">React</a></span>
            
              <span><a class="tab-title" id="#ThreeJS" href="/#ThreeJS">ThreeJS</a></span>
            
              <span><a class="tab-title" id="#Vue" href="/#Vue">Vue</a></span>
            
              <span><a class="tab-title" id="#Work" href="/#Work">Work</a></span>
            
          </div>
      
  <div id="toc" class="toc-article">
    <!--<strong class="toc-title">目录</strong>-->
    <ol class="toc"><li class="toc-item toc-level-3"><a class="toc-link" href="#1-元素"><span class="toc-text">1. 元素</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#2-绘制"><span class="toc-text">2. 绘制</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#2-1-矩形"><span class="toc-text">2.1 矩形</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#2-2-圆弧"><span class="toc-text">2.2 圆弧</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#2-3-路径"><span class="toc-text">2.3 路径</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#2-4-贝塞尔曲线"><span class="toc-text">2.4 贝塞尔曲线</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#3-使用样式和颜色"><span class="toc-text">3. 使用样式和颜色</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#3-1-描边，填充"><span class="toc-text">3.1 描边，填充</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#3-2-渐变"><span class="toc-text">3.2 渐变</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#3-3-图案样式"><span class="toc-text">3.3 图案样式</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#3-4-阴影"><span class="toc-text">3.4 阴影</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#4-文本和图片"><span class="toc-text">4. 文本和图片</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#5-变形"><span class="toc-text">5. 变形</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#5-1-状态的保存和恢复"><span class="toc-text">5.1 状态的保存和恢复</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#5-2-移动，旋转，变形，缩放"><span class="toc-text">5.2 移动，旋转，变形，缩放</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#6-其它"><span class="toc-text">6. 其它</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#6-1-动画"><span class="toc-text">6.1 动画</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#6-2-颜色选择器"><span class="toc-text">6.2 颜色选择器</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#6-3-图片灰度和反相颜色"><span class="toc-text">6.3 图片灰度和反相颜色</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#6-4-把canvas保存为图片"><span class="toc-text">6.4 把canvas保存为图片</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#6-5-websocket实现白板功能"><span class="toc-text">6.5 websocket实现白板功能</span></a></li></ol></li></ol>
  </div>


<div class="section">
  <article class="post" id="post">
    <header class="post-header text-center">
      <h1 class="title">
        Canvas实现白板功能
      </h1>
      
      <time class="time" datetime="2018-10-06T07:56:08.000Z">
        2018-10-06
      </time>
      
      <hr>
    </header>
    <div class="post-content">
      <h3 id="1-元素"><a href="#1-元素" class="headerlink" title="1. 元素"></a>1. 元素</h3><ul>
<li><p>canvas元素<br>canvas是一个可以使用JS来绘制图形的HTML元素。canvas标签只有两个属性——width和height。</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&lt;canvas id=<span class="string">"tutorial"</span> width=<span class="string">"150"</span> height=<span class="string">"150"</span>&gt;<span class="xml"><span class="tag">&lt;/<span class="name">canvas</span>&gt;</span></span></span><br></pre></td></tr></table></figure>
</li>
<li><p>渲染上下文<br>canvas元素创造了一个固定大小的画布，它公开了一个或多个渲染上下文，用来绘制和处理要展示的内容。</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">var</span> canvas = <span class="built_in">document</span>.getElementById(<span class="string">'tutorial'</span>);</span><br><span class="line"><span class="keyword">var</span> ctx    = canvas.getContext(<span class="string">'2d'</span>);</span><br></pre></td></tr></table></figure>
</li>
<li><p>坐标<br>画布的起点为左上角(坐标(0, 0))，所有元素的位置都相对于原点定位。<br><img src="/2018/10/06/Canvas文档/1.png" style="padding-top:20px; max-width: 380px"><br><br></p>
</li>
</ul>
<h3 id="2-绘制"><a href="#2-绘制" class="headerlink" title="2. 绘制"></a>2. 绘制</h3><h4 id="2-1-矩形"><a href="#2-1-矩形" class="headerlink" title="2.1 矩形"></a>2.1 矩形</h4><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">ctx.fillRect(x, y, width, height)     绘制一个填充的矩形</span><br><span class="line">ctx.strokeRect(x, y, width, height)   绘制一个矩形的边框</span><br><span class="line">ctx.clearRect(x, y, width, height)    清除指定矩形区域，让清除部分完全透明</span><br></pre></td></tr></table></figure>
<h4 id="2-2-圆弧"><a href="#2-2-圆弧" class="headerlink" title="2.2 圆弧"></a>2.2 圆弧</h4><p>画一个以(x,y)为圆心的radius为半径的圆，从startAngle开始到endAngle结束，按照anticlockwise给定的方向(默认顺时针)生成。<br><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">ctx.arc(x, y, radius, startAngle, endAngle, anticlockwise)</span><br></pre></td></tr></table></figure></p>
<p>根据给定的控制点和半径画一段圆弧，再以直线连接两个控制点。<br><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">ctx.acrTo(x1, y1, x2, y2, radius)</span><br></pre></td></tr></table></figure></p>
<h4 id="2-3-路径"><a href="#2-3-路径" class="headerlink" title="2.3 路径"></a>2.3 路径</h4><p>路径是通过不同颜色和宽度的线段/曲线相连形成的不同形状的店的集合。绘制图形的步骤：①创建路径起点；②使用画图命令画出路径；③封闭路径；④通过描边或填充路径来渲染图形。<br><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">ctx.beginPath()   新建路径</span><br><span class="line">ctx.moveTo(x,y)   将笔触移动到(x,y)上</span><br><span class="line">ctx.lineTo(x,y)   绘制一条从当前位置到(x,y)的直线</span><br><span class="line">ctx.closePath()   闭合路径</span><br><span class="line">ctx.stroke()      绘制路径</span><br><span class="line">ctx.fill()        填充路径</span><br></pre></td></tr></table></figure></p>
<h4 id="2-4-贝塞尔曲线"><a href="#2-4-贝塞尔曲线" class="headerlink" title="2.4 贝塞尔曲线"></a>2.4 贝塞尔曲线</h4><p>二次贝塞尔曲线, cplx,cply为一个控制点, x,y为结束点<br><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">quadraticCurveTo(cplx, cply, x, y)</span><br></pre></td></tr></table></figure></p>
<p>三次贝塞尔曲线, cplx,cply为控制点1, cp2x,cp2y为控制点2, x,y为结束点<br><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">bezierCurveTo(cplx, cply, cp2x, cp2y, x, y)</span><br></pre></td></tr></table></figure></p>
<p><img src="/2018/10/06/Canvas文档/2.png" style="padding-top:20px; max-width: 380px"><br><br></p>
<h3 id="3-使用样式和颜色"><a href="#3-使用样式和颜色" class="headerlink" title="3. 使用样式和颜色"></a>3. 使用样式和颜色</h3><h4 id="3-1-描边，填充"><a href="#3-1-描边，填充" class="headerlink" title="3.1 描边，填充"></a>3.1 描边，填充</h4><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">ctx.fillStyle = color               设置图形的填充颜色</span><br><span class="line">ctx.strokeStyle = color             设置图形轮廓的颜色</span><br><span class="line">ctx.globalAlpha = transparencyValue 设置canvas里所有图形的透明度</span><br><span class="line"></span><br><span class="line"><span class="comment">// 线型</span></span><br><span class="line">lineWidth = <span class="number">1</span>                       设置线条宽度      </span><br><span class="line">lineCap = <span class="string">'butt/round/square'</span>       设置线条末端样式</span><br><span class="line">lineJoin = <span class="string">'round/bevel/miter'</span>      设定线条与线条间接合处的样式</span><br><span class="line">miterLimit = <span class="number">1</span>                      限制两条线相交时交接处最大长度</span><br><span class="line">getLineDash()                       返回当前虚线样式</span><br><span class="line">setLineDash([<span class="number">4</span>, <span class="number">2</span>])                 设置当前虚线样式，接受一个数组来指定线段与间隙的交替</span><br><span class="line">lineDashOffset = value              设置虚线样式的起始偏移量</span><br></pre></td></tr></table></figure>
<h4 id="3-2-渐变"><a href="#3-2-渐变" class="headerlink" title="3.2 渐变"></a>3.2 渐变</h4><p>我们可以用线性或径向的渐变来填充或描边。新建一个<code>canvasGradient</code>对象，并且赋给<code>fillStyle或strokeStyle</code>属性。<br><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 创建canvasGradient对象</span></span><br><span class="line"><span class="keyword">var</span> lineargradient = ctx.createLinearGradient(x1, y1, x2, y2);</span><br><span class="line"><span class="keyword">var</span> radialgradient = ctx.createRadialGradient(x1, y1, r1, x2, y2, r2);</span><br><span class="line"></span><br><span class="line"><span class="comment">// 添加任意多个色标</span></span><br><span class="line">lineargradient.addColorStop(<span class="number">0</span>, <span class="string">'#000'</span>);</span><br><span class="line">lineargradient.addColorStop(<span class="number">1</span>, <span class="string">'#fff'</span>);</span><br><span class="line"></span><br><span class="line"><span class="comment">// assign gradients to fill and stroke styles</span></span><br><span class="line">ctx.fillStyle = lineargradient;</span><br><span class="line">ctx.strokeStyle = lineargradient;</span><br><span class="line"></span><br><span class="line"><span class="comment">// draw shapes</span></span><br></pre></td></tr></table></figure></p>
<h4 id="3-3-图案样式"><a href="#3-3-图案样式" class="headerlink" title="3.3 图案样式"></a>3.3 图案样式</h4><p>图案的应用和渐变很像，创建出一个pattern后，赋给<code>fillStyle或strokeStyle</code>属性即可。<br><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">var</span> img = <span class="keyword">new</span> Image();</span><br><span class="line">img.src = <span class="string">'someimage.png'</span>;</span><br><span class="line"><span class="keyword">var</span> ptrn = ctx.createPattern(img, type)</span><br><span class="line"><span class="comment">// type可选repeat, repeat-x, repeat-y, no-repeat</span></span><br></pre></td></tr></table></figure></p>
<h4 id="3-4-阴影"><a href="#3-4-阴影" class="headerlink" title="3.4 阴影"></a>3.4 阴影</h4><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">ctx.shadowOffsetX = float   设定阴影在X轴的延伸距离</span><br><span class="line">ctx.shadowOffsetY = float   设定阴影在Y轴的延伸距离</span><br><span class="line">ctx.shadowBlur    = float   设定阴影的模糊程度</span><br><span class="line">ctx.shadowColor   = color   设定阴影颜色</span><br><span class="line">ctx.font = <span class="string">'123'</span>;</span><br><span class="line">ctx.fillStyle = <span class="string">'#000'</span>;</span><br><span class="line">ctx.fillText(<span class="string">'Sample String'</span>, <span class="number">5</span>, <span class="number">30</span>);</span><br></pre></td></tr></table></figure>
<p><br></p>
<h3 id="4-文本和图片"><a href="#4-文本和图片" class="headerlink" title="4. 文本和图片"></a>4. 文本和图片</h3><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">ctx.font = <span class="string">'10px sans-serif'</span>;</span><br><span class="line">ctx.textAlign = <span class="string">'start/end/left/right/center'</span>;</span><br><span class="line">ctx.textBaseline = <span class="string">'top/hanging/middle/alphabetic/ideographic/bottom'</span>;</span><br><span class="line">ctx.direction = <span class="string">'ltr/rtl/inherit'</span>;</span><br><span class="line"></span><br><span class="line">ctx.fillText(text, x, y, maxWdith)    在指定的(x,y)位置填充指定文本，绘制的最大宽度可选</span><br><span class="line">ctx.strokeText(text, x, y, maxWidth)  在指定的(x,y)位置绘制指定文本，绘制的最大宽度可选</span><br><span class="line"></span><br><span class="line"><span class="comment">// 预测量文本宽度</span></span><br><span class="line"><span class="keyword">var</span> text = ctx.measureText(<span class="string">'foo'</span>);</span><br><span class="line">text.width <span class="comment">// 16</span></span><br></pre></td></tr></table></figure>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">drawImage(image, x, y)                                              绘制图片</span><br><span class="line">drawImage(image, x, y, width, height)                               绘制图片(缩放)</span><br><span class="line">drawImage(image, sx, sy, sWidth, sHeight, dx, dy, dWidth, dHeight3) 切片</span><br></pre></td></tr></table></figure>
<p><img src="/2018/10/06/Canvas文档/3.jpg" style="padding-top:20px; max-width: 380px"><br><br></p>
<h3 id="5-变形"><a href="#5-变形" class="headerlink" title="5. 变形"></a>5. 变形</h3><h4 id="5-1-状态的保存和恢复"><a href="#5-1-状态的保存和恢复" class="headerlink" title="5.1 状态的保存和恢复"></a>5.1 状态的保存和恢复</h4><p>Canvas状态存储在栈中，每当<code>save()</code>方法被调用后，当前的状态就被推送到栈中。你可以调用任意多次<code>save</code>方法，每一次调用<code>restore</code>方法，上一个保存的状态就从栈中弹出，所有设定都恢复。</p>
<p>一个绘画状态包括：①当前应用的变形(移动、旋转、缩放)；②strokeStyle, fillStyle, globalAlpha, lineWidth, lineCap, lineJoin, miterLimit, shadowOffsetX, shadowOffsetY, shadowBlur, shadowColor, globalCompositeOperation 的值； ③当前的裁切路径<br><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">ctx.save()    保存canvas状态</span><br><span class="line">ctx.restore() 恢复canvas状态</span><br></pre></td></tr></table></figure></p>
<h4 id="5-2-移动，旋转，变形，缩放"><a href="#5-2-移动，旋转，变形，缩放" class="headerlink" title="5.2 移动，旋转，变形，缩放"></a>5.2 移动，旋转，变形，缩放</h4><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">ctx.translate(x, y)   [移动]移动canvas和它的原点到一个不同的位置</span><br><span class="line">ctx.rotate(angle)     [旋转]以原点为中心旋转canvas</span><br><span class="line">ctx.scale(x, y)       [缩放]对形状，位图进行缩小或者放大，x, y默认值为<span class="number">1</span></span><br><span class="line">ctx.transform(m11, m12, m21, m22, dx, dy) [变形]</span><br><span class="line">ctx.transform(水平方向的缩放，水平方向的倾斜偏移，竖直方向的缩放，竖直方向的倾斜偏移，水平方向的移动，竖直方向的移动)</span><br></pre></td></tr></table></figure>
<p><img src="/2018/10/06/Canvas文档/4.png" style="padding-top:20px; max-width: 380px"></p>
<p><br></p>
<h3 id="6-其它"><a href="#6-其它" class="headerlink" title="6. 其它"></a>6. 其它</h3><h4 id="6-1-动画"><a href="#6-1-动画" class="headerlink" title="6.1 动画"></a>6.1 动画</h4><p>保存canvas状态, 清空canvas, 重绘动画帧。<a href="https://developer.mozilla.org/zh-CN/docs/Web/API/Canvas_API/Tutorial/Advanced_animations" target="_blank" rel="noopener">高级动画示例</a></p>
<h4 id="6-2-颜色选择器"><a href="#6-2-颜色选择器" class="headerlink" title="6.2 颜色选择器"></a>6.2 颜色选择器</h4><p>像素操作: <code>ctx.getImageData(left, top, width, height)</code><br><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">var</span> img = <span class="keyword">new</span> Image();</span><br><span class="line">img.src = <span class="string">'https://mdn.mozillademos.org/files/5397/rhino.jpg'</span>;</span><br><span class="line"><span class="keyword">var</span> canvas = <span class="built_in">document</span>.getElementById(<span class="string">'canvas'</span>);</span><br><span class="line"><span class="keyword">var</span> ctx = canvas.getContext(<span class="string">'2d'</span>);</span><br><span class="line">img.onload = <span class="function"><span class="keyword">function</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">  ctx.drawImage(img, <span class="number">0</span>, <span class="number">0</span>);</span><br><span class="line">  img.style.display = <span class="string">'none'</span>;</span><br><span class="line">&#125;;</span><br><span class="line"><span class="keyword">var</span> color = <span class="built_in">document</span>.getElementById(<span class="string">'color'</span>);</span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">pick</span>(<span class="params">event</span>) </span>&#123;</span><br><span class="line">  <span class="keyword">var</span> x = event.layerX;</span><br><span class="line">  <span class="keyword">var</span> y = event.layerY;</span><br><span class="line">  <span class="keyword">var</span> pixel = ctx.getImageData(x, y, <span class="number">1</span>, <span class="number">1</span>);</span><br><span class="line">  <span class="keyword">var</span> data = pixel.data;</span><br><span class="line">  <span class="keyword">var</span> rgba = <span class="string">'rgba('</span> + data[<span class="number">0</span>] + <span class="string">','</span> + data[<span class="number">1</span>] +</span><br><span class="line">             <span class="string">','</span> + data[<span class="number">2</span>] + <span class="string">','</span> + (data[<span class="number">3</span>] / <span class="number">255</span>) + <span class="string">')'</span>;</span><br><span class="line">  color.style.background =  rgba;</span><br><span class="line">  color.textContent = rgba;</span><br><span class="line">&#125;</span><br><span class="line">canvas.addEventListener(<span class="string">'mousemove'</span>, pick);</span><br></pre></td></tr></table></figure></p>
<h4 id="6-3-图片灰度和反相颜色"><a href="#6-3-图片灰度和反相颜色" class="headerlink" title="6.3 图片灰度和反相颜色"></a>6.3 图片灰度和反相颜色</h4><p>在场景中写入像素数据: <code>ctx.putImageData(myImageData, dx, dy)</code><br><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">var</span> img = <span class="keyword">new</span> Image();</span><br><span class="line">img.src = <span class="string">'https://mdn.mozillademos.org/files/5397/rhino.jpg'</span>;</span><br><span class="line">img.onload = <span class="function"><span class="keyword">function</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">  draw(<span class="keyword">this</span>);</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">draw</span>(<span class="params">img</span>) </span>&#123;</span><br><span class="line">  <span class="keyword">var</span> canvas = <span class="built_in">document</span>.getElementById(<span class="string">'canvas'</span>);</span><br><span class="line">  <span class="keyword">var</span> ctx = canvas.getContext(<span class="string">'2d'</span>);</span><br><span class="line">  ctx.drawImage(img, <span class="number">0</span>, <span class="number">0</span>);</span><br><span class="line">  img.style.display = <span class="string">'none'</span>;</span><br><span class="line">  <span class="keyword">var</span> imageData = ctx.getImageData(<span class="number">0</span>,<span class="number">0</span>,canvas.width, canvas.height);</span><br><span class="line">  <span class="keyword">var</span> data = imageData.data;</span><br><span class="line">    </span><br><span class="line">  <span class="keyword">var</span> invert = <span class="function"><span class="keyword">function</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">    <span class="keyword">for</span> (<span class="keyword">var</span> i = <span class="number">0</span>; i &lt; data.length; i += <span class="number">4</span>) &#123;</span><br><span class="line">      data[i]     = <span class="number">225</span> - data[i];     <span class="comment">// red</span></span><br><span class="line">      data[i + <span class="number">1</span>] = <span class="number">225</span> - data[i + <span class="number">1</span>]; <span class="comment">// green</span></span><br><span class="line">      data[i + <span class="number">2</span>] = <span class="number">225</span> - data[i + <span class="number">2</span>]; <span class="comment">// blue</span></span><br><span class="line">    &#125;</span><br><span class="line">    ctx.putImageData(imageData, <span class="number">0</span>, <span class="number">0</span>);</span><br><span class="line">  &#125;;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">var</span> grayscale = <span class="function"><span class="keyword">function</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">    <span class="keyword">for</span> (<span class="keyword">var</span> i = <span class="number">0</span>; i &lt; data.length; i += <span class="number">4</span>) &#123;</span><br><span class="line">      <span class="keyword">var</span> avg = (data[i] + data[i +<span class="number">1</span>] + data[i +<span class="number">2</span>]) / <span class="number">3</span>;</span><br><span class="line">      data[i]     = avg; <span class="comment">// red</span></span><br><span class="line">      data[i + <span class="number">1</span>] = avg; <span class="comment">// green</span></span><br><span class="line">      data[i + <span class="number">2</span>] = avg; <span class="comment">// blue</span></span><br><span class="line">    &#125;</span><br><span class="line">    ctx.putImageData(imageData, <span class="number">0</span>, <span class="number">0</span>);</span><br><span class="line">  &#125;;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">var</span> invertbtn = <span class="built_in">document</span>.getElementById(<span class="string">'invertbtn'</span>);</span><br><span class="line">  invertbtn.addEventListener(<span class="string">'click'</span>, invert);</span><br><span class="line">  <span class="keyword">var</span> grayscalebtn = <span class="built_in">document</span>.getElementById(<span class="string">'grayscalebtn'</span>);</span><br><span class="line">  grayscalebtn.addEventListener(<span class="string">'click'</span>, grayscale);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<h4 id="6-4-把canvas保存为图片"><a href="#6-4-把canvas保存为图片" class="headerlink" title="6.4 把canvas保存为图片"></a>6.4 把canvas保存为图片</h4><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">canvas.toDataURL(<span class="string">'image/png'</span>, quality)        创建一个png图片,<span class="number">0</span><span class="number">-1</span>的品质量,<span class="number">1</span>最好</span><br><span class="line">canvas.toBlob(callback, type, encoderOptions) 创建一个画布中代表图片的Blob对象</span><br></pre></td></tr></table></figure>
<h4 id="6-5-websocket实现白板功能"><a href="#6-5-websocket实现白板功能" class="headerlink" title="6.5 websocket实现白板功能"></a>6.5 websocket实现白板功能</h4><ul>
<li>绘制线条，直线，椭圆，矩形(可选择画笔粗细，线条颜色，填充颜色)</li>
<li>写字，输入框中输入确定后显示在画布上</li>
<li>橡皮檫，清空画布</li>
<li>撤销，恢复功能(再执行最近一次操作)</li>
</ul>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br><span class="line">218</span><br><span class="line">219</span><br><span class="line">220</span><br><span class="line">221</span><br><span class="line">222</span><br><span class="line">223</span><br><span class="line">224</span><br><span class="line">225</span><br><span class="line">226</span><br><span class="line">227</span><br><span class="line">228</span><br><span class="line">229</span><br><span class="line">230</span><br><span class="line">231</span><br><span class="line">232</span><br><span class="line">233</span><br><span class="line">234</span><br><span class="line">235</span><br><span class="line">236</span><br><span class="line">237</span><br><span class="line">238</span><br><span class="line">239</span><br><span class="line">240</span><br><span class="line">241</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">repaint</span>(<span class="params">ctx, strokes</span>) </span>&#123;</span><br><span class="line">  ctx.clearRect(<span class="number">0</span>, <span class="number">0</span>, ctx.canvas.width, ctx.canvas.height);</span><br><span class="line">  <span class="keyword">if</span> (strokes === <span class="literal">undefined</span>) &#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">  &#125;</span><br><span class="line">  strokes.map(<span class="function">(<span class="params">stroke</span>) =&gt;</span> &#123;</span><br><span class="line">    <span class="keyword">const</span> &#123; strokeColor, width, graphType &#125; = stroke;</span><br><span class="line">    ctx.strokeStyle = strokeColor;</span><br><span class="line">    ctx.lineWidth = width;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">const</span> startX = stroke.data[<span class="number">0</span>].x;</span><br><span class="line">    <span class="keyword">const</span> startY = stroke.data[<span class="number">0</span>].y;</span><br><span class="line">    <span class="keyword">const</span> &#123; x, y &#125; = stroke.data[stroke.data.length - <span class="number">1</span>];</span><br><span class="line"></span><br><span class="line">    ctx.beginPath();</span><br><span class="line">    <span class="keyword">if</span> (graphType === <span class="string">'pencil'</span>) &#123;</span><br><span class="line">      <span class="keyword">for</span> (<span class="keyword">let</span> i = <span class="number">0</span>; i &lt; stroke.data.length; i++) &#123;</span><br><span class="line">        <span class="keyword">const</span> prev = stroke.data[i - <span class="number">1</span>];</span><br><span class="line">        <span class="keyword">const</span> current = stroke.data[i];</span><br><span class="line">        <span class="keyword">if</span> (prev !== <span class="literal">undefined</span>) &#123;</span><br><span class="line">          ctx.moveTo(prev.x, prev.y);</span><br><span class="line">        &#125;</span><br><span class="line">        ctx.lineTo(current.x, current.y);</span><br><span class="line">      &#125;</span><br><span class="line">    &#125; <span class="keyword">else</span> <span class="keyword">if</span> (graphType === <span class="string">'line'</span>) &#123;</span><br><span class="line">      ctx.moveTo(startX, startY);</span><br><span class="line">      ctx.lineTo(x, y);</span><br><span class="line">    &#125; <span class="keyword">else</span> <span class="keyword">if</span> (graphType === <span class="string">'circle'</span>) &#123;</span><br><span class="line">      <span class="comment">// const radii = Math.sqrt((startX - x) * (startX - x) + (startY - y) * (startY - y));</span></span><br><span class="line">      <span class="comment">// ctx.arc(startX, startY, radii, 0, Math.PI * 2, false);</span></span><br><span class="line">      <span class="comment">// 椭圆</span></span><br><span class="line">      ctx.save();</span><br><span class="line">      <span class="keyword">const</span> o1 = (startX + x) / <span class="number">2</span>;</span><br><span class="line">      <span class="keyword">const</span> o2 = (startY + y) / <span class="number">2</span>;</span><br><span class="line">      <span class="keyword">const</span> a = <span class="built_in">Math</span>.abs((x - startX) / <span class="number">2</span>);</span><br><span class="line">      <span class="keyword">const</span> b = <span class="built_in">Math</span>.abs((y - startY) / <span class="number">2</span>);</span><br><span class="line">      <span class="keyword">const</span> r = (a &gt; b) ? a : b;</span><br><span class="line">      <span class="keyword">const</span> ratioX = a / r;</span><br><span class="line">      <span class="keyword">const</span> ratioY = b / r;</span><br><span class="line">      ctx.scale(ratioX, ratioY);</span><br><span class="line">      ctx.arc(o1 / ratioX, o2 / ratioY, r, <span class="number">0</span>, <span class="number">2</span> * <span class="built_in">Math</span>.PI, <span class="literal">false</span>);</span><br><span class="line">      ctx.restore();</span><br><span class="line"></span><br><span class="line">    &#125; <span class="keyword">else</span> <span class="keyword">if</span> (graphType === <span class="string">'square'</span>) &#123;</span><br><span class="line">      ctx.moveTo(startX, startY);</span><br><span class="line">      ctx.lineTo(x, startY);</span><br><span class="line">      ctx.lineTo(x, y);</span><br><span class="line">      ctx.lineTo(startX, y);</span><br><span class="line">      ctx.lineTo(startX, startY);</span><br><span class="line">    &#125; <span class="keyword">else</span> <span class="keyword">if</span> (graphType === <span class="string">'rubber'</span>) &#123;</span><br><span class="line">      <span class="keyword">for</span> (<span class="keyword">let</span> i = <span class="number">0</span>; i &lt; stroke.data.length; i++) &#123;</span><br><span class="line">        <span class="keyword">const</span> &#123; x, y &#125; = stroke.data[i];</span><br><span class="line">        <span class="comment">// 操作清除像素</span></span><br><span class="line">        <span class="keyword">const</span> size = <span class="number">2</span>;</span><br><span class="line">        ctx.strokeStyle = <span class="string">'#000000'</span>;</span><br><span class="line">        ctx.clearRect(x - size * <span class="number">10</span> ,  y - size * <span class="number">10</span> , size * <span class="number">20</span> , size * <span class="number">20</span>);</span><br><span class="line">      &#125;</span><br><span class="line">    &#125; <span class="keyword">else</span> <span class="keyword">if</span> (graphType === <span class="string">'text'</span>) &#123;</span><br><span class="line">      ctx.font = <span class="string">"16px Microsoft YaHei"</span>;</span><br><span class="line">      ctx.fillStyle = strokeColor;</span><br><span class="line">      ctx.fillText(stroke.text, startX, startY);</span><br><span class="line">    &#125;</span><br><span class="line">    ctx.stroke();</span><br><span class="line">    ctx.closePath();</span><br><span class="line">  &#125;);</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">export</span> <span class="keyword">default</span> <span class="class"><span class="keyword">class</span> <span class="title">WhiteBoard</span> </span>&#123;</span><br><span class="line">  <span class="keyword">constructor</span>(options) &#123;</span><br><span class="line">    <span class="keyword">this</span>.canvas = <span class="built_in">document</span>.getElementById(<span class="string">'canvas'</span>);</span><br><span class="line">    <span class="keyword">this</span>.ctx = <span class="keyword">this</span>.canvas.getContext(<span class="string">'2d'</span>);</span><br><span class="line">    <span class="keyword">this</span>.isDrawing = <span class="literal">false</span>;</span><br><span class="line">    <span class="keyword">this</span>.strokeColor = <span class="string">'#000'</span>;</span><br><span class="line">    <span class="keyword">this</span>.lineWidth = <span class="number">2</span>; <span class="comment">// 线的宽度</span></span><br><span class="line">    <span class="keyword">this</span>.graphType = <span class="string">'pencil'</span>;</span><br><span class="line">    <span class="keyword">this</span>.strokes = [];</span><br><span class="line">    <span class="keyword">this</span>.redo = [];</span><br><span class="line">    <span class="keyword">this</span>.textSite = &#123;&#125;;</span><br><span class="line">    <span class="keyword">const</span> &#123; wid, token &#125; = options;</span><br><span class="line">    <span class="keyword">const</span> ws = <span class="string">`ws://live.ngrok.elitemc.cn:8000/ws/whiteboard-<span class="subst">$&#123;wid&#125;</span>?token=<span class="subst">$&#123;token&#125;</span>`</span>;</span><br><span class="line">    <span class="keyword">this</span>.socket = <span class="keyword">new</span> WebSocket(ws);</span><br><span class="line">    <span class="keyword">this</span>.init();</span><br><span class="line">  &#125;</span><br><span class="line">  init = <span class="function"><span class="params">()</span> =&gt;</span> &#123;</span><br><span class="line">    <span class="keyword">const</span> &#123; canvas, ctx &#125; = <span class="keyword">this</span>;</span><br><span class="line">    canvas.onmousedown = <span class="function">(<span class="params">event</span>) =&gt;</span> &#123;</span><br><span class="line">      <span class="keyword">this</span>.isDrawing = <span class="literal">true</span>;</span><br><span class="line">      <span class="keyword">const</span> x = event.clientX - canvas.getBoundingClientRect().x;</span><br><span class="line">      <span class="keyword">const</span> y = event.clientY - canvas.getBoundingClientRect().y;</span><br><span class="line"></span><br><span class="line">      <span class="comment">// 在该坐标上设置文本框</span></span><br><span class="line">      <span class="keyword">if</span> (<span class="keyword">this</span>.graphType === <span class="string">'text'</span>) &#123;</span><br><span class="line">        <span class="keyword">this</span>.showTextBox(x, y);</span><br><span class="line">      &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        <span class="keyword">this</span>.addPoint(x, y, <span class="literal">true</span>);</span><br><span class="line">      &#125;</span><br><span class="line"></span><br><span class="line">      <span class="comment">// 如果是橡皮檫，清空画布，重绘，显示橡皮檫</span></span><br><span class="line">      <span class="keyword">if</span> (<span class="keyword">this</span>.graphType === <span class="string">'rubber'</span>) &#123;</span><br><span class="line">        <span class="keyword">this</span>.showRubber(x, y);</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;;</span><br><span class="line">    canvas.onmousemove = <span class="function">(<span class="params">event</span>) =&gt;</span> &#123;</span><br><span class="line">      <span class="keyword">const</span> x = event.clientX - canvas.getBoundingClientRect().x;</span><br><span class="line">      <span class="keyword">const</span> y = event.clientY - canvas.getBoundingClientRect().y;</span><br><span class="line"></span><br><span class="line">      <span class="keyword">if</span> (<span class="keyword">this</span>.graphType === <span class="string">'text'</span>) &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">      &#125;</span><br><span class="line">      <span class="comment">// 记录操作,并重绘</span></span><br><span class="line">      <span class="keyword">if</span> (<span class="keyword">this</span>.isDrawing) &#123;</span><br><span class="line">        <span class="keyword">this</span>.addPoint(x, y);</span><br><span class="line">      &#125;</span><br><span class="line"></span><br><span class="line">      <span class="comment">// 如果是橡皮檫，清空画布，重绘，显示橡皮檫</span></span><br><span class="line">      <span class="keyword">if</span> (<span class="keyword">this</span>.graphType === <span class="string">'rubber'</span>) &#123;</span><br><span class="line">        <span class="keyword">this</span>.showRubber(x, y);</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;;</span><br><span class="line">    canvas.onmouseup = <span class="function"><span class="params">()</span> =&gt;</span> &#123;</span><br><span class="line">      <span class="keyword">this</span>.isDrawing = <span class="literal">false</span>;</span><br><span class="line">      <span class="keyword">if</span> (<span class="keyword">this</span>.graphType === <span class="string">'text'</span>) &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">      &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        <span class="keyword">this</span>.sendStrokes();</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;;</span><br><span class="line">    canvas.onmouseleave = <span class="function"><span class="params">()</span> =&gt;</span> &#123;</span><br><span class="line">      <span class="keyword">this</span>.isDrawing = <span class="literal">false</span>;</span><br><span class="line">      <span class="keyword">if</span> (<span class="keyword">this</span>.graphType === <span class="string">'rubber'</span>) &#123;</span><br><span class="line">        <span class="comment">// 隐藏橡皮檫</span></span><br><span class="line">        <span class="keyword">this</span>.ctx.clearRect(<span class="number">0</span>, <span class="number">0</span>, canvas.width, canvas.height);</span><br><span class="line">        <span class="keyword">this</span>.repaint();</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;;</span><br><span class="line">  &#125;</span><br><span class="line">  showTextBox = <span class="function">(<span class="params">x, y</span>) =&gt;</span> &#123;</span><br><span class="line">    <span class="keyword">const</span> textElem = <span class="built_in">document</span>.getElementById(<span class="string">'text'</span>);</span><br><span class="line">    textElem.style.display = <span class="string">'block'</span>;</span><br><span class="line">    textElem.style.top = y + <span class="string">'px'</span>;</span><br><span class="line">    textElem.style.left = x + <span class="string">'px'</span>;</span><br><span class="line">    <span class="keyword">this</span>.textSite = &#123; x, y &#125;;</span><br><span class="line">  &#125;</span><br><span class="line">  showRubber = <span class="function">(<span class="params">x, y</span>) =&gt;</span> &#123;</span><br><span class="line">    <span class="comment">// 如果是橡皮檫，清空画布，重绘，显示橡皮檫</span></span><br><span class="line">    <span class="keyword">const</span> &#123; ctx &#125; = <span class="keyword">this</span>;</span><br><span class="line">    ctx.lineWidth = <span class="number">1</span>;</span><br><span class="line">    ctx.clearRect(<span class="number">0</span>, <span class="number">0</span>, canvas.width, canvas.height);</span><br><span class="line">    <span class="keyword">this</span>.repaint();</span><br><span class="line"></span><br><span class="line">    ctx.beginPath();</span><br><span class="line">    ctx.strokeStyle = <span class="string">'#000000'</span>;</span><br><span class="line">    <span class="keyword">const</span> size = <span class="number">2</span>;</span><br><span class="line">    ctx.moveTo(x - size * <span class="number">10</span> , y - size * <span class="number">10</span> );</span><br><span class="line">    ctx.lineTo(x + size * <span class="number">10</span> , y - size * <span class="number">10</span> );</span><br><span class="line">    ctx.lineTo(x + size * <span class="number">10</span> , y + size * <span class="number">10</span> );</span><br><span class="line">    ctx.lineTo(x - size * <span class="number">10</span> , y + size * <span class="number">10</span> );</span><br><span class="line">    ctx.lineTo(x - size * <span class="number">10</span> , y - size * <span class="number">10</span> );</span><br><span class="line">    ctx.stroke();</span><br><span class="line">  &#125;</span><br><span class="line">  sendStrokes = <span class="function"><span class="params">()</span> =&gt;</span> &#123;</span><br><span class="line">    <span class="keyword">this</span>.socket.send(<span class="built_in">JSON</span>.stringify(&#123; <span class="attr">kind</span>: <span class="number">1</span>, <span class="attr">points</span>: <span class="keyword">this</span>.strokes &#125;));</span><br><span class="line">  &#125;</span><br><span class="line">  addPoint = <span class="function">(<span class="params">x, y, newStroke, str</span>) =&gt;</span> &#123;</span><br><span class="line">    <span class="keyword">const</span> p = &#123; x, y &#125;;</span><br><span class="line">    <span class="keyword">const</span> &#123; graphType &#125; = <span class="keyword">this</span>;</span><br><span class="line">    <span class="keyword">if</span> (graphType === <span class="string">'text'</span>) &#123;</span><br><span class="line">      <span class="keyword">const</span> d = &#123; <span class="attr">data</span>: [p], <span class="attr">text</span>: str, <span class="attr">strokeColor</span>: <span class="keyword">this</span>.strokeColor, <span class="attr">graphType</span>: <span class="keyword">this</span>.graphType &#125;;</span><br><span class="line">      <span class="keyword">this</span>.strokes.push(d);</span><br><span class="line">    &#125; <span class="keyword">else</span> <span class="keyword">if</span> (newStroke) &#123;</span><br><span class="line">      <span class="keyword">const</span> d = &#123; <span class="attr">data</span>: [p], <span class="attr">strokeColor</span>: <span class="keyword">this</span>.strokeColor, <span class="attr">width</span>: <span class="keyword">this</span>.lineWidth, <span class="attr">graphType</span>: <span class="keyword">this</span>.graphType &#125;;</span><br><span class="line">      <span class="keyword">this</span>.strokes.push(d);</span><br><span class="line">    &#125; <span class="keyword">else</span> <span class="keyword">if</span> (graphType === <span class="string">'pencil'</span> || graphType === <span class="string">'rubber'</span>) &#123;</span><br><span class="line">      <span class="keyword">this</span>.strokes[<span class="keyword">this</span>.strokes.length - <span class="number">1</span>].data.push(p);</span><br><span class="line">    &#125; <span class="keyword">else</span> <span class="keyword">if</span> (graphType === <span class="string">'line'</span> || graphType === <span class="string">'circle'</span> || graphType === <span class="string">'square'</span>) &#123;</span><br><span class="line">      <span class="keyword">this</span>.strokes[<span class="keyword">this</span>.strokes.length - <span class="number">1</span>].data[<span class="number">1</span>] = p;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">this</span>.repaint();</span><br><span class="line">  &#125;</span><br><span class="line">  repaint = <span class="function"><span class="params">()</span> =&gt;</span> &#123;</span><br><span class="line">    <span class="comment">// 清空再重绘</span></span><br><span class="line">    repaint(<span class="keyword">this</span>.ctx, <span class="keyword">this</span>.strokes);</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="comment">// 设置画笔粗细</span></span><br><span class="line">  setLineWidth = <span class="function">(<span class="params">width</span>) =&gt;</span> &#123;</span><br><span class="line">    <span class="keyword">this</span>.lineWidth = width;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="comment">// 设置类型 &#123;pencil, line, circle, square, rubber, text&#125;</span></span><br><span class="line">  setGraphType = <span class="function">(<span class="params">graphType</span>) =&gt;</span> &#123;</span><br><span class="line">    <span class="keyword">this</span>.graphType = graphType;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="comment">// 设置画笔颜色</span></span><br><span class="line">  setGraphColor = <span class="function">(<span class="params">color</span>) =&gt;</span> &#123;</span><br><span class="line">    <span class="keyword">this</span>.strokeColor = color;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="comment">// 清空</span></span><br><span class="line">  clear = <span class="function"><span class="params">()</span> =&gt;</span> &#123;</span><br><span class="line">    <span class="keyword">this</span>.strokes = [];</span><br><span class="line">    <span class="keyword">this</span>.ctx.clearRect(<span class="number">0</span>, <span class="number">0</span>, canvas.width, canvas.height);</span><br><span class="line">    <span class="keyword">this</span>.sendStrokes();</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="comment">// 撤销</span></span><br><span class="line">  cancelOneStep = <span class="function"><span class="params">()</span> =&gt;</span> &#123;</span><br><span class="line">    <span class="keyword">if</span> (<span class="keyword">this</span>.strokes.length &gt; <span class="number">0</span>) &#123;</span><br><span class="line">      <span class="keyword">this</span>.redo.push(<span class="keyword">this</span>.strokes[<span class="keyword">this</span>.strokes.length - <span class="number">1</span>]);</span><br><span class="line">      <span class="keyword">this</span>.strokes.pop();</span><br><span class="line">      <span class="keyword">this</span>.repaint();</span><br><span class="line">      <span class="keyword">this</span>.sendStrokes();</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="comment">// 恢复：再执行最近依次操作</span></span><br><span class="line">  redoStep = <span class="function"><span class="params">()</span> =&gt;</span> &#123;</span><br><span class="line">    <span class="keyword">if</span> (<span class="keyword">this</span>.redo.length &gt; <span class="number">0</span>) &#123;</span><br><span class="line">      <span class="keyword">this</span>.strokes.push(<span class="keyword">this</span>.redo[<span class="keyword">this</span>.redo.length - <span class="number">1</span>]);</span><br><span class="line">      <span class="keyword">this</span>.redo.pop();</span><br><span class="line">      <span class="keyword">this</span>.repaint();</span><br><span class="line">      <span class="keyword">this</span>.sendStrokes();</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">export</span> <span class="class"><span class="keyword">class</span> <span class="title">ClientBoard</span> </span>&#123;</span><br><span class="line">  <span class="keyword">constructor</span>(options) &#123;</span><br><span class="line">    <span class="keyword">this</span>.canvas = <span class="built_in">document</span>.getElementById(<span class="string">'canvas'</span>);</span><br><span class="line">    <span class="keyword">this</span>.ctx = <span class="keyword">this</span>.canvas.getContext(<span class="string">'2d'</span>);</span><br><span class="line">    <span class="keyword">const</span> &#123; wid, token &#125; = options;</span><br><span class="line">    <span class="keyword">const</span> ws = <span class="string">`ws://live.ngrok.elitemc.cn:8000/ws/whiteboard-<span class="subst">$&#123;wid&#125;</span>?token=<span class="subst">$&#123;token&#125;</span>`</span>;</span><br><span class="line">    <span class="keyword">this</span>.socket = <span class="keyword">new</span> WebSocket(ws);</span><br><span class="line">    <span class="keyword">this</span>.socket.onmessage = <span class="function">(<span class="params">event</span>) =&gt;</span> &#123;</span><br><span class="line">      <span class="keyword">const</span> messages = event.data.split(<span class="string">'\n'</span>);</span><br><span class="line">      messages.map(<span class="function">(<span class="params">data</span>) =&gt;</span> &#123;</span><br><span class="line">        <span class="keyword">this</span>.onMessage(<span class="built_in">JSON</span>.parse(data));</span><br><span class="line">      &#125;)</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">this</span>.socket.onopen = <span class="function">(<span class="params">event</span>) =&gt;</span> &#123;</span><br><span class="line">      <span class="comment">// console.log(event);</span></span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">  onMessage = <span class="function">(<span class="params">message</span>) =&gt;</span> &#123;</span><br><span class="line">    repaint(<span class="keyword">this</span>.ctx, message.points);</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
    </div>
  </article>
    
    <div class="post-nav">
      <div class="post-nav-item post-nav-next">
        
          <span>〈 </span>
          <a href="/2018/10/06/CSS文档/" rel="next" title="CSS文档">
          CSS文档
          </a>
        
      </div>
  
      <div class="post-nav-item post-nav-prev">
        
          <a href="/2018/10/07/DOM/" rel="prev" title="DOM 如何生成？提供了哪些API？">
            DOM 如何生成？提供了哪些API？
          </a>
          <span>〉</span>
        
      </div>
    </div>
  
</div>


<script>
var link = document.getElementsByClassName('toc-link');
var hash = decodeURIComponent(location.hash);
if (hash){
} else {
  link[0].classList.add('toc-link-active');
}

var h3 = document.getElementsByTagName('h3');
var h4 = document.getElementsByTagName('h4');
var h5 = document.getElementsByTagName('h5');
var link_arr = [];
function addToArr(arr){
  for(var i = 0; i < arr.length; i++){
    link_arr.push(arr[i].offsetTop);
  }
}
addToArr(h3);
addToArr(h4);
addToArr(h5);


var compare = function (x, y) {
    if (x < y) {
        return -1;
    } else if (x > y) {
        return 1;
    } else {
        return 0;
    }
}

link_arr.sort(compare);


window.onscroll = function(){
  var height = document.documentElement.scrollTop;
  for (var i = 0; i < link_arr.length; i++){
    if (link_arr[i] > height){
      for(var j = 0; j < link.length; j++){
        link[j].classList.remove('toc-link-active');
      }
      document.getElementsByClassName('toc-link')[i].classList.add('toc-link-active');
      break;
    } 
  }
}

</script>
    </div>
  </div>
  




    <script src="https://cdn.jsdelivr.net/npm/pangu@4.0.7/dist/browser/pangu.min.js"></script>
    
    <script>
      document.addEventListener('DOMContentLoaded', () => {
        // listen to any DOM change and automatically perform spacing via MutationObserver()
        pangu.autoSpacingPage();
      });

      window.addEventListener("load", event => {
        // 判断浏览器是否支持
        if ("serviceWorker" in navigator) {
          window.navigator.serviceWorker
            .register("/sw.js", {
              scope: "/"
            })
        }
      });
    </script>
</body>
</html>

